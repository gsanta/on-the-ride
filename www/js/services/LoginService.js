// Generated by CoffeeScript 1.7.1
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  angular.module('services').factory('LoginService', function($http, $q) {
    var db, factoryObj, idbSupported, openConnection;
    idbSupported = false;
    if (__indexOf.call(window, "indexedDB") >= 0) {
      idbSupported = true;
    }
    db = void 0;
    openConnection = function() {
      var connRequest;
      connRequest = indexedDB.open(MapConstants.dbPrefix, MapConstants.indexedDbVersion);
      connRequest.onupgradeneeded = function(e) {
        var thisDB;
        console.log("upgradeneedeed");
        thisDB = e.target.result;
        if (!thisDB.objectStoreNames.contains("eurovelo_6")) {
          return thisDB.createObjectStore("eurovelo_6", {
            autoIncrement: true
          });
        }
      };
      connRequest.onerror = function(e) {
        console.log("Error");
        return console.dir(e);
      };
      return connRequest;
    };
    factoryObj = {
      login: function(userName, password) {
        var deferred, loadUserInfoFromIndexedDb;
        deferred = $q.defer();
        loadUserInfoFromIndexedDb = function(def, userName) {
          var cursor, store, transaction, user;
          transaction = db.transaction(["eurovelo_6"], "readonly");
          store = transaction.objectStore("users");
          cursor = store.openCursor();
          user = {};
          cursor.onsuccess = function(e) {
            var actUser;
            actUser = e.target.result;
            if (actUser.value.userName === userName) {
              user.id = actUser.key;
              return user.userName = actUser.value.userName;
            } else {
              return actUser["continue"]();
            }
          };
          return transaction.oncomplete = function(e) {
            return def.resolve(route);
          };
        };
        loadRouteInfoFromIndexedDb(deferred, userName);
        return deferred.promise;
      },
      addUser: function(User) {
        var addUserToIndexedDb, deferred;
        deferred = $q.defer();
        addUserToIndexedDb = function(def) {
          var request, store, transaction;
          transaction = db.transaction(["eurovelo_6"], "readwrite");
          store = transaction.objectStore("users");
          request = store.add(User);
          request.onsuccess = function(e) {
            return def.resolve(User);
          };
          return request.onerror = function(e) {
            return def.reject("problem with signing up");
          };
        };
        addUserToIndexedDb(deferred);
        return deferred.promise;
      }
    };
    return factoryObj;
  });

}).call(this);
